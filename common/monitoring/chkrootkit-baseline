#!/bin/bash

BASELINE_FILE="/var/lib/chkrootkit/baseline.txt"
BASELINE_DIR="/var/lib/chkrootkit"
CURRENT_RUN="/tmp/chkrootkit_current.txt"
DIFF_OUTPUT="/tmp/chkrootkit_diff.txt"

# Create directory if it doesn't exist
mkdir -p $BASELINE_DIR

# Function to create baseline
create_baseline() {
  echo "Creating baseline from current system state..."
  sudo chkrootkit > $BASELINE_FILE
  echo "Baseline created at $BASELINE_FILE"
}

# Function to check against baseline
check_against_baseline() {
  echo "Running chkrootkit and comparing to baseline..."
  sudo chkrootkit > $CURRENT_RUN
  
  # Compare with baseline
  diff $BASELINE_FILE $CURRENT_RUN > $DIFF_OUTPUT
  
  if [ -s $DIFF_OUTPUT ]; then
    echo "ALERT: Differences detected from baseline!"
    echo "=== Differences from baseline ==="
    cat $DIFF_OUTPUT
    echo "=================================="
    echo "Current run saved in $CURRENT_RUN"
    echo "For full details, review both files or run 'diff $BASELINE_FILE $CURRENT_RUN'"
  else
    echo "No differences detected from baseline."
    rm $CURRENT_RUN
    rm $DIFF_OUTPUT
  fi
}

# Main logic
if [ "$1" == "update" ]; then
  create_baseline
elif [ ! -f $BASELINE_FILE ]; then
  echo "No baseline found. Creating initial baseline."
  create_baseline
else
  check_against_baseline
fi
